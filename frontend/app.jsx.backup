const { useEffect, useRef, useState } = React;

const LANG_OPTIONS = [
  "de_DE",
  "el_GR",
  "en_GB",
  "en_US",
  "fr_FR",
  "hr_HR",
  "it_IT",
  "ja_JP",
  "ko_KR",
  "nb_NO",
  "pt_PT",
  "ru_RU",
  "sv_SE",
  "tr_TR",
  "zh_CN",
];

const DEFAULT_STATE = {
  languages: LANG_OPTIONS,
  has_compose: false,
  has_meta: false,
  has_stage2: false,
  meta: null,
  llm: {},
};

function Panel({ title, intro, actions, children, eyebrow, className }) {
  return (
    <section className={`panel${className ? ` ${className}` : ""}`}>
      <div className="panel-head">
        <div>
          {eyebrow && <span className="panel-eyebrow">{eyebrow}</span>}
          <h2>{title}</h2>
          {intro && <small>{intro}</small>}
        </div>
        {actions && <div className="panel-actions">{actions}</div>}
      </div>
      {children}
    </section>
  );
}

function StatusBanner({ message }) {
  if (!message) {
    return null;
  }
  return <div className="status">{message}</div>;
}

function SegmentedToggle({ value, options, onChange, className }) {
  return (
    <div className={`segmented${className ? ` ${className}` : ""}`}>
      {options.map((option) => (
        <button
          key={option.value}
          type="button"
          className={value === option.value ? "active" : ""}
          aria-pressed={value === option.value}
          onClick={() => onChange(option.value)}
        >
          {option.label}
        </button>
      ))}
    </div>
  );
}

function AssistantOverlay({
  open,
  target,
  context,
  messages,
  input,
  loading,
  onTargetChange,
  onInputChange,
  onSend,
  onReset,
  onClose,
  onApplyMulti,
  onApplySingle,
  endRef,
}) {
  if (!open) {
    return null;
  }
  return (
    <div className="assistant-overlay">
      <div className="assistant-window">
        <div className="assistant-header">
          <div>
            <div className="badge">Copilot</div>
            <h3 style={{ margin: "0.25rem 0" }}>LLM Dialog</h3>
            <small>
              Target: {target || "general guidance"}
              {context && (
                <span>
                  <br />
                  Context: {context}
                </span>
              )}
            </small>
          </div>
          <div className="assistant-actions">
            <button className="ghost" onClick={onReset}>
              Reset Thread
            </button>
            <button onClick={onClose}>Close</button>
          </div>
        </div>
        <div className="assistant-messages">
          {messages.map((msg, index) => (
            <div
              key={index}
              className={`assistant-message ${msg.role === "user" ? "user" : "assistant"}`}
            >
              {msg.content}
            </div>
          ))}
          {loading && <div className="assistant-message assistant">Thinking...</div>}
          <div ref={endRef} />
        </div>
        <div className="assistant-controls">
          <div className="assistant-toolbar">
            <input
              type="text"
              placeholder="Target path (app.title, service:web:port:8080...)"
              value={target}
              onChange={(event) => onTargetChange(event.target.value)}
            />
            <textarea
              placeholder="Ask the copilot for a rewrite or description... (Ctrl+Enter to send)"
              value={input}
              onChange={(event) => onInputChange(event.target.value)}
              onKeyDown={(event) => {
                if ((event.metaKey || event.ctrlKey) && event.key === "Enter") {
                  event.preventDefault();
                  onSend();
                }
              }}
            />
            <button onClick={onSend} disabled={loading}>
              {loading ? "Sending..." : "Send"}
            </button>
          </div>
          <div className="assistant-actions">
            <button onClick={onApplyMulti}>Apply to Multi-language</button>
            <button onClick={onApplySingle}>Apply to Single-language</button>
          </div>
        </div>
      </div>
    </div>
  );
}

function useStatusMessage(timeout = 4200) {
  const [message, setMessage] = useState("");
  const timerRef = useRef(null);

  const show = (text) => {
    setMessage(text);
    if (timerRef.current) {
      clearTimeout(timerRef.current);
    }
    if (text) {
      timerRef.current = setTimeout(() => setMessage(""), timeout);
    }
  };

  useEffect(
    () => () => {
      if (timerRef.current) {
        clearTimeout(timerRef.current);
      }
    },
    []
  );

  return [message, show];
}

async function requestJSON(url, options) {
  const response = await fetch(url, options);
  const hasJSON = response.headers.get("content-type")?.includes("application/json");
  const data = hasJSON ? await response.json() : {};
  if (!response.ok) {
    const detail = data.detail || data.message || "Request failed";
    throw new Error(detail);
  }
  return data;
}

async function requestText(url, options) {
  const response = await fetch(url, options);
  const text = await response.text();
  if (!response.ok) {
    let detail = "Request failed";
    try {
      const payload = JSON.parse(text);
      detail = payload.detail || detail;
    } catch {
      detail = text || detail;
    }
    throw new Error(detail);
  }
  return text;
}

function App() {
  const [state, setState] = useState(DEFAULT_STATE);
  const [useLLM, setUseLLM] = useState(true);
  const [useParams, setUseParams] = useState(true);
  const [metaMode, setMetaMode] = useState("multi");
  const [metaTarget, setMetaTarget] = useState("");
  const [metaValue, setMetaValue] = useState("");
  const [exportOutput, setExportOutput] = useState("");
  const [composeText, setComposeText] = useState("");
  const [model, setModel] = useState("gpt-4.1-mini");
  const [temperature, setTemperature] = useState(0.2);
  const [llmBaseUrl, setLlmBaseUrl] = useState("");
  const [llmApiKey, setLlmApiKey] = useState("");
  const [llmSettingsOpen, setLlmSettingsOpen] = useState(true);
  const [paramsEditorOpen, setParamsEditorOpen] = useState(true);
  const [paramsDirty, setParamsDirty] = useState(false);
  const [paramsForm, setParamsForm] = useState({
    store_folder: "",
    author: "",
    developer: "",
    title: "",
    tagline: "",
    description: "",
  });
  const [assistantOpen, setAssistantOpen] = useState(false);
  const [assistantTarget, setAssistantTarget] = useState("");
  const [assistantInput, setAssistantInput] = useState("");
  const [assistantMessages, setAssistantMessages] = useState([]);
  const [assistantLastText, setAssistantLastText] = useState("");
  const [assistantContext, setAssistantContext] = useState("");
  const [assistantLoading, setAssistantLoading] = useState(false);
  const [status, showStatus] = useStatusMessage();

  const fileRef = useRef(null);
  const paramsFileRef = useRef(null);
  const assistantEndRef = useRef(null);

  const refreshState = async () => {
    try {
      const data = await requestJSON("/api/state");
      setState(data);
    } catch (error) {
      showStatus(error.message);
    }
  };

  useEffect(() => {
    refreshState();
  }, []);

  useEffect(() => {
    const llm = state.llm || {};
    if (llm.base_url) {
      setLlmBaseUrl(llm.base_url);
    }
    if (llm.api_key) {
      setLlmApiKey("********");
    }
    if (llm.model) {
      setModel(llm.model);
    }
    if (typeof llm.temperature === "number") {
      setTemperature(llm.temperature);
    }
  }, [state.llm]);

  const seedParamsFromMeta = (meta) => {
    if (!meta || !meta.app) {
      return;
    }
    setParamsForm({
      store_folder: "",
      author: meta.app.author || "",
      developer: meta.app.developer || "",
      title: meta.app.title || "",
      tagline: meta.app.tagline || "",
      description: meta.app.description || "",
    });
    setParamsDirty(false);
  };

  const updateParamsField = (field, value) => {
    setParamsDirty(true);
    setParamsForm((prev) => ({ ...prev, [field]: value }));
  };

  const buildParamsPayload = () => ({
    app: {
      store_folder: paramsForm.store_folder.trim(),
      author: paramsForm.author.trim(),
      developer: paramsForm.developer.trim(),
      title: paramsForm.title.trim(),
      tagline: paramsForm.tagline.trim(),
      description: paramsForm.description,
    },
  });

  useEffect(() => {
    const handler = (event) => {
      if (event.ctrlKey && event.key.toLowerCase() === "l") {
        event.preventDefault();
        openAssistant(metaTarget || "app.title");
      }
    };
    window.addEventListener("keydown", handler);
    return () => window.removeEventListener("keydown", handler);
  }, []);

  useEffect(() => {
    if (!assistantOpen) {
      return;
    }
    const handler = (event) => {
      if (event.key === "Escape") {
        setAssistantOpen(false);
      }
    };
    window.addEventListener("keydown", handler);
    return () => window.removeEventListener("keydown", handler);
  }, [assistantOpen]);

  useEffect(() => {
    assistantEndRef.current?.scrollIntoView({ behavior: "smooth" });
  }, [assistantMessages, assistantLoading]);

  const openAssistant = (targetHint) => {
    if (targetHint) {
      setAssistantTarget(targetHint);
    }
    setAssistantOpen(true);
  };

  const resetAssistantThread = () => {
    setAssistantMessages([]);
    setAssistantInput("");
    setAssistantLastText("");
    setAssistantContext("");
  };

  const saveLLMSettings = async () => {
    const formData = new FormData();
    formData.append("base_url", llmBaseUrl);
    if (llmApiKey && llmApiKey !== "********") {
      formData.append("api_key", llmApiKey);
    }
    formData.append("model", model);
    formData.append("temperature", temperature);
    try {
      const data = await requestJSON("/api/llm", { method: "POST", body: formData });
      setState((prev) => ({ ...prev, llm: data.llm }));
      showStatus("LLM settings saved.");
    } catch (error) {
      showStatus(error.message);
    }
  };

  const loadCompose = async () => {
    if (!fileRef.current || !fileRef.current.files.length) {
      showStatus("Please choose a docker-compose file.");
      return;
    }
    try {
      const formData = new FormData();
      formData.append("file", fileRef.current.files[0]);
      const data = await requestJSON("/api/compose", { method: "POST", body: formData });
      showStatus(data.message || "Compose loaded.");
      seedParamsFromMeta(data.meta);
      refreshState();
    } catch (error) {
      showStatus(error.message);
    }
  };

  const loadComposeText = async () => {
    if (!composeText.trim()) {
      showStatus("Paste a docker-compose YAML first.");
      return;
    }
    try {
      const data = await requestJSON("/api/compose-text", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text: composeText }),
      });
      showStatus(data.message || "Compose loaded.");
      seedParamsFromMeta(data.meta);
      refreshState();
    } catch (error) {
      showStatus(error.message);
    }
  };

  const fillMetadata = async () => {
    if (!state.has_compose) {
      showStatus("Load a compose file first.");
      return;
    }
    if (!useLLM && !useParams) {
      showStatus("Select LLM or Params.");
      return;
    }
    const fillData = new FormData();
    fillData.append("use_llm", useLLM ? "true" : "false");
    fillData.append("use_params", useParams ? "true" : "false");
    if (useLLM) {
      fillData.append("model", model);
      fillData.append("temperature", temperature);
      if (llmBaseUrl) {
        fillData.append("llm_base_url", llmBaseUrl);
      }
      if (llmApiKey && llmApiKey !== "********") {
        fillData.append("llm_api_key", llmApiKey);
      }
    }
    if (useParams) {
      if (paramsFileRef.current && paramsFileRef.current.files.length) {
        fillData.append("params_file", paramsFileRef.current.files[0]);
      } else {
        fillData.append("params_json", JSON.stringify(buildParamsPayload()));
      }
    }
    try {
      await requestJSON("/api/meta/fill", { method: "POST", body: fillData });
      const modeLabel = [useLLM ? "LLM" : null, useParams ? "params" : null]
        .filter(Boolean)
        .join(" + ");
      showStatus(`Metadata updated (${modeLabel}).`);
      refreshState();
    } catch (error) {
      showStatus(error.message);
    }
  };

  const renderCompose = async () => {
    try {
      await requestJSON("/api/render", { method: "POST" });
      showStatus("x-casaos rendered.");
      refreshState();
    } catch (error) {
      showStatus(error.message);
    }
  };

  const updateMetaField = async () => {
    if (!metaTarget || !metaValue) {
      showStatus("Target and value are required.");
      return;
    }
    const endpoint =
      metaMode === "multi" ? "/api/stage2/update-multi" : "/api/stage2/update-single";
    try {
      await requestJSON(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ target: metaTarget, value: metaValue }),
      });
      showStatus("Metadata updated.");
      setMetaValue("");
      refreshState();
    } catch (error) {
      showStatus(error.message);
    }
  };

  const exportCompose = async () => {
    try {
      const text = await requestText("/api/export", { method: "POST" });
      setExportOutput(text);
      showStatus("CasaOS YAML generated.");
    } catch (error) {
      showStatus(error.message);
    }
  };

  const sendAssistant = async () => {
    if (!assistantInput.trim()) {
      showStatus("Enter a question or rewrite request for the copilot.");
      return;
    }
    const userMessage = { role: "user", content: assistantInput.trim() };
    const nextMessages = [...assistantMessages, userMessage];
    setAssistantMessages(nextMessages);
    setAssistantInput("");
    setAssistantLoading(true);
    try {
      const data = await requestJSON("/api/assistant/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ messages: nextMessages, target: assistantTarget || null }),
      });
      const assistantMessage = { role: "assistant", content: data.message };
      setAssistantMessages((prev) => [...prev, assistantMessage]);
      setAssistantLastText(data.message);
      setAssistantContext(data.context || "");
    } catch (error) {
      showStatus(error.message);
    } finally {
      setAssistantLoading(false);
    }
  };

  const applyAssistantMulti = async () => {
    if (!assistantTarget) {
      showStatus("Select a target for the assistant.");
      return;
    }
    if (!assistantLastText) {
      showStatus("Ask the assistant for a suggestion first.");
      return;
    }
    try {
      await requestJSON("/api/stage2/update-multi", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ target: assistantTarget, value: assistantLastText }),
      });
      showStatus("Assistant text copied to every language.");
      refreshState();
    } catch (error) {
      showStatus(error.message);
    }
  };

  const applyAssistantSingle = async () => {
    if (!assistantTarget) {
      showStatus("Select a target for the assistant.");
      return;
    }
    if (!assistantLastText) {
      showStatus("Ask the assistant for a suggestion first.");
      return;
    }
    try {
      await requestJSON("/api/stage2/update-single", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ target: assistantTarget, value: assistantLastText }),
      });
      showStatus("Assistant text saved to single-language field.");
      refreshState();
    } catch (error) {
      showStatus(error.message);
    }
  };

  return (
    <div>
      <header className="hero">
        <div>
          <div className="badge">Visual Editor</div>
          <h1>CasaOS Compose Visual Editor</h1>
          <small>
            Upload a compose file and edit metadata visually.
            Multi-language values are always updated across every locale.
          </small>
        </div>
        <div className="hero-actions">
          <button className="ghost" onClick={refreshState}>
            Refresh
          </button>
        </div>
      </header>

      <StatusBanner message={status} />

      <div className="layout">
        <div className="workflow-track">
          <div className="workflow-row">
            <Panel
              className="step step-1"
              eyebrow="Step 1"
              title="Load Compose"
              intro="Upload or paste a docker-compose.yml file to begin."
              actions={
                <div className="status-row">
                  <span className={`pill ${state.has_compose ? "active" : ""}`}>Compose</span>
                  <span className={`pill ${state.has_meta ? "active" : ""}`}>Meta</span>
                  <span className={`pill ${state.has_stage2 ? "active" : ""}`}>Rendered</span>
                </div>
              }
            >
              <label>docker-compose file</label>
              <input ref={fileRef} type="file" accept=".yml,.yaml" />
              <div className="panel-inline">
                <button onClick={loadCompose}>Load Compose</button>
                <button className="ghost" onClick={refreshState}>
                  Refresh State
                </button>
              </div>
              <div className="mode-pill">Paste compose YAML</div>
              <label>compose text</label>
              <textarea
                value={composeText}
                onChange={(event) => setComposeText(event.target.value)}
                placeholder="Paste docker-compose.yml content here..."
              />
              <button onClick={loadComposeText}>Load Compose Text</button>
            </Panel>

            <div className="workflow-connector" aria-hidden="true" />

            <Panel
              className="step step-2"
              eyebrow="Step 2"
              title="Fill Metadata"
              intro="Use LLM and/or params to fill metadata before rendering."
            >
              <div className="mode-pill">
                Plan:{" "}
                {useLLM && useParams
                  ? "LLM + Params"
                  : useLLM
                  ? "LLM only"
                  : useParams
                  ? "Params only"
                  : "Select options"}
              </div>
              <div className="panel-inline">
                <div className="checkbox-row">
                  <input
                    type="checkbox"
                    checked={useLLM}
                    onChange={(event) => setUseLLM(event.target.checked)}
                  />
                  <span>Use LLM</span>
                </div>
                <div className="checkbox-row">
                  <input
                    type="checkbox"
                    checked={useParams}
                    onChange={(event) => setUseParams(event.target.checked)}
                  />
                  <span>Use Params (core fields)</span>
                </div>
              </div>
              {useLLM && (
                <div className="collapsible">
                  <button
                    type="button"
                    className="collapsible-trigger"
                    aria-expanded={llmSettingsOpen}
                    onClick={() => setLlmSettingsOpen((prev) => !prev)}
                  >
                    <span>LLM Settings</span>
                    <span className="collapsible-meta">
                      {model} / temp {temperature}
                    </span>
                    <span className="chevron" aria-hidden="true">
                      v
                    </span>
                  </button>
                  <div className={`collapsible-body ${llmSettingsOpen ? "open" : ""}`}>
                    <div className="collapsible-inner">
                      <label>LLM Base URL</label>
                      <input
                        type="text"
                        placeholder="https://api.openai.com/v1"
                        value={llmBaseUrl}
                        onChange={(event) => setLlmBaseUrl(event.target.value)}
                      />
                      <label>LLM API Key</label>
                      <input
                        type="password"
                        placeholder="sk-..."
                        value={llmApiKey}
                        onChange={(event) => setLlmApiKey(event.target.value)}
                      />
                      <label>Model</label>
                      <input
                        type="text"
                        value={model}
                        onChange={(event) => setModel(event.target.value)}
                      />
                      <label>Temperature</label>
                      <input
                        type="number"
                        min="0"
                        max="1"
                        step="0.1"
                        value={temperature}
                        onChange={(event) => setTemperature(event.target.value)}
                      />
                      <button className="ghost" onClick={saveLLMSettings}>
                        Save LLM Settings
                      </button>
                    </div>
                  </div>
                </div>
              )}
              {useParams && (
                <div className="collapsible">
                  <button
                    type="button"
                    className="collapsible-trigger"
                    aria-expanded={paramsEditorOpen}
                    onClick={() => setParamsEditorOpen((prev) => !prev)}
                  >
                    <span>Params (core fields)</span>
                    <span className="collapsible-meta">
                      {paramsForm.title || "customize"}
                    </span>
                    <span className="chevron" aria-hidden="true">
                      v
                    </span>
                  </button>
                  <div className={`collapsible-body ${paramsEditorOpen ? "open" : ""}`}>
                    <div className="collapsible-inner">
                      <label>Store Folder</label>
                      <input
                        type="text"
                        placeholder="RagFlow"
                        value={paramsForm.store_folder}
                        onChange={(event) => updateParamsField("store_folder", event.target.value)}
                      />
                      <label>Author</label>
                      <input
                        type="text"
                        value={paramsForm.author}
                        onChange={(event) => updateParamsField("author", event.target.value)}
                      />
                      <label>Developer</label>
                      <input
                        type="text"
                        value={paramsForm.developer}
                        onChange={(event) => updateParamsField("developer", event.target.value)}
                      />
                      <label>Title</label>
                      <input
                        type="text"
                        value={paramsForm.title}
                        onChange={(event) => updateParamsField("title", event.target.value)}
                      />
                      <label>Tagline</label>
                      <input
                        type="text"
                        value={paramsForm.tagline}
                        onChange={(event) => updateParamsField("tagline", event.target.value)}
                      />
                      <label>Description</label>
                      <textarea
                        value={paramsForm.description}
                        onChange={(event) => updateParamsField("description", event.target.value)}
                        placeholder="Short introduction for the app."
                      />
                      <label>params.yml (optional, overrides form)</label>
                      <input ref={paramsFileRef} type="file" accept=".yml,.yaml" />
                      {paramsDirty && (
                        <button className="ghost" onClick={() => seedParamsFromMeta(state.meta)}>
                          Reset to inferred defaults
                        </button>
                      )}
                    </div>
                  </div>
                </div>
              )}
              <button onClick={fillMetadata} disabled={!state.has_compose}>
                Run Fill
              </button>
            </Panel>

            <div className="workflow-connector" aria-hidden="true" />

            <Panel
              className="step step-3"
              eyebrow="Step 3"
              title="Edit Metadata"
              intro="Edit x-casaos fields. Multi-language updates every locale."
            >
              <label>Mode</label>
              <SegmentedToggle
                value={metaMode}
                onChange={setMetaMode}
                options={[
                  { value: "multi", label: "Multi-language" },
                  { value: "single", label: "Single-language" },
                ]}
              />
              <label>Target</label>
              <input
                type="text"
                value={metaTarget}
                placeholder={
                  metaMode === "multi" ? "app.title or service:web:port:8080" : "service:web:index"
                }
                onChange={(event) => setMetaTarget(event.target.value)}
              />
              <label>{metaMode === "multi" ? "Content" : "Value"}</label>
              {metaMode === "multi" ? (
                <textarea
                  value={metaValue}
                  onChange={(event) => setMetaValue(event.target.value)}
                  placeholder="Describe once and it will sync to all locales."
                />
              ) : (
                <input type="text" value={metaValue} onChange={(event) => setMetaValue(event.target.value)} />
              )}
              <div className="panel-inline">
                <button onClick={updateMetaField}>Save Metadata</button>
                <button className="ghost" onClick={renderCompose}>
                  Render x-casaos
                </button>
              </div>
            </Panel>

            <div className="workflow-connector" aria-hidden="true" />

            <Panel
              className="step step-4"
              eyebrow="Step 4"
              title="Export YAML"
              intro="Generate the final compose file with x-casaos."
            >
              <button onClick={exportCompose}>Export CasaOS YAML</button>
              <textarea
                value={exportOutput}
                onChange={(event) => setExportOutput(event.target.value)}
                placeholder="CasaOS YAML preview..."
              />
            </Panel>
          </div>
        </div>
      </div>

      <AssistantOverlay
        open={assistantOpen}
        target={assistantTarget}
        context={assistantContext}
        messages={assistantMessages}
        input={assistantInput}
        loading={assistantLoading}
        onTargetChange={setAssistantTarget}
        onInputChange={setAssistantInput}
        onSend={sendAssistant}
        onReset={resetAssistantThread}
        onClose={() => setAssistantOpen(false)}
        onApplyMulti={applyAssistantMulti}
        onApplySingle={applyAssistantSingle}
        endRef={assistantEndRef}
      />
    </div>
  );
}

const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(<App />);
