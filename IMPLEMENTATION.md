# CasaOS Compose Generator - åŒç»´åº¦åŠŸèƒ½å®ç°å®Œæˆ

## ğŸ‰ å·²å®Œæˆçš„åŠŸèƒ½

### **ç»´åº¦ 1: æ™ºèƒ½ç”Ÿæˆä¸ AI æ¶¦è‰²**

#### 1.1 ç”¨æˆ·è¾“å…¥æ§åˆ¶
- âœ… æ‰©å±•äº†æ•°æ®æ¨¡å‹ï¼ˆ`models.py`ï¼‰
  - æ·»åŠ  `user_input` å­—æ®µï¼šæ ‡è®°ç”¨æˆ·æä¾›çš„å†…å®¹
  - æ·»åŠ  `multilang` å­—æ®µï¼šæ§åˆ¶æ˜¯å¦å¤šè¯­è¨€åŒ–
- âœ… æ”¯æŒä¸‰ç§ description æ¥æºï¼š
  - **AI è‡ªåŠ¨ç”Ÿæˆ**ï¼šç©ºç™½å­—æ®µç”± AI å¡«å……
  - **ç”¨æˆ·è¾“å…¥**ï¼šç”¨æˆ·æä¾›åˆå§‹æ–‡æœ¬
  - **AI æ¶¦è‰²**ï¼šä¿æŒç”¨æˆ·åŸæ„çš„ä¸“ä¸šåŒ–æ”¹å†™

#### 1.2 AI æ¶¦è‰²æ¨¡å¼
- âœ… æ–°å¢ `refine_mode.py` æ¨¡å—
- âœ… æ¶¦è‰²ç­–ç•¥ï¼šä¿æŒæ ¸å¿ƒå«ä¹‰ï¼Œåªæ”¹è¿›è¡¨è¾¾
- âœ… Prompt ä¼˜åŒ–ï¼šä¸“æ³¨äºæ¸…æ™°åº¦å’Œä¸“ä¸šæ€§

#### 1.3 å­—æ®µçº§å¤šè¯­è¨€æ§åˆ¶
- âœ… ä¿®æ”¹ `i18n.py` æ”¯æŒæ¡ä»¶æ€§ç¿»è¯‘
- âœ… æŠ€æœ¯å­—æ®µå¯æ ‡è®°ä¸º `multilang: false` ä¿æŒå•è¯­è¨€
- âœ… ç”¨æˆ·ç•Œé¢å­—æ®µé»˜è®¤å¤šè¯­è¨€åŒ–

---

### **ç»´åº¦ 2: ç‰ˆæœ¬ç®¡ç†ä¸å¢é‡æ›´æ–°**

#### 2.1 æ ¸å¿ƒå¢é‡åŠŸèƒ½
- âœ… **diff_engine.py** - æ™ºèƒ½å·®å¼‚å¯¹æ¯”
  - æœåŠ¡çº§åˆ«ï¼šæ–°å¢/åˆ é™¤æœåŠ¡æ£€æµ‹
  - å­—æ®µçº§åˆ«ï¼šports/envs/volumes å˜æ›´è¿½è¸ª
  - å·®å¼‚æŠ¥å‘Šï¼šå‹å¥½çš„æ‘˜è¦æ ¼å¼

- âœ… **version_manager.py** - è‡ªåŠ¨ç‰ˆæœ¬æ§åˆ¶
  - SHA256 å“ˆå¸Œæ£€æµ‹æ–‡ä»¶å˜åŒ–
  - è‡ªåŠ¨å¤‡ä»½ï¼ˆæœ€å¤šä¿ç•™ 3 ä¸ªå†å²ç‰ˆæœ¬ï¼‰
  - ç‰ˆæœ¬å›æ»šåŠŸèƒ½
  - é…ç½®æ–‡ä»¶æŒä¹…åŒ–

- âœ… **incremental.py** - å¢é‡æ›´æ–°æµç¨‹
  - è‡ªåŠ¨æ£€æµ‹ compose å˜åŒ–
  - ä¿ç•™å·²æœ‰ descriptionï¼ˆå·² AI ç”Ÿæˆçš„å†…å®¹ï¼‰
  - åªå¯¹æ–°å¢å­—æ®µè°ƒç”¨ AIï¼ˆèŠ‚çœæˆæœ¬ï¼‰
  - æ™ºèƒ½åˆå¹¶æ—§å…ƒæ•°æ®ä¸æ–°ç»“æ„

#### 2.2 CLI å‘½ä»¤æ‰©å±•
- âœ… `--incremental`: å¢é‡æ›´æ–°æ¨¡å¼
- âœ… `--force-regenerate`: å¼ºåˆ¶é‡æ–°ç”Ÿæˆ
- âœ… `--list-versions`: åˆ—å‡ºå†å²ç‰ˆæœ¬
- âœ… `--rollback VERSION`: å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬
- âœ… `--show-diff`: æ˜¾ç¤ºå˜æ›´å·®å¼‚ï¼ˆä¸å®é™…æ›´æ–°ï¼‰
- âœ… `--work-dir`: è‡ªå®šä¹‰ç‰ˆæœ¬ç®¡ç†ç›®å½•

#### 2.3 Web UI API æ‰©å±•
- âœ… `GET /api/versions` - åˆ—å‡ºæ‰€æœ‰å†å²ç‰ˆæœ¬
- âœ… `POST /api/versions/rollback` - å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬
- âœ… `GET /api/diff` - è·å– compose å·®å¼‚
- âœ… `POST /api/incremental` - æ‰§è¡Œå¢é‡æ›´æ–°

---

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### 1. CLI ä½¿ç”¨

#### é¦–æ¬¡ç”Ÿæˆ
```bash
# å®Œæ•´æµç¨‹ï¼ˆè§£æ + AI ç”Ÿæˆ + å¤šè¯­è¨€ï¼‰
uv run casaos-gen compose.yml --output casaos.yml

# ä½¿ç”¨è‡ªå®šä¹‰ params
uv run casaos-gen compose.yml --params my-params.yml
```

#### å¢é‡æ›´æ–°ï¼ˆæ¨èï¼‰
```bash
# è‡ªåŠ¨æ£€æµ‹å˜åŒ–ï¼Œä¿ç•™å·²æœ‰å†…å®¹
uv run casaos-gen compose.yml --incremental

# æŸ¥çœ‹å·®å¼‚ï¼ˆä¸å®é™…æ›´æ–°ï¼‰
uv run casaos-gen compose.yml --show-diff

# å¼ºåˆ¶é‡æ–°ç”Ÿæˆ
uv run casaos-gen compose.yml --force-regenerate
```

#### ç‰ˆæœ¬ç®¡ç†
```bash
# æŸ¥çœ‹å†å²ç‰ˆæœ¬
uv run casaos-gen --list-versions

# è¾“å‡ºç¤ºä¾‹ï¼š
# meta.20260108_143022.json - 2026-01-08 14:30:22  (12.3 KB)
# meta.20260108_120510.json - 2026-01-08 12:05:10  (11.8 KB)
# meta.20260107_163045.json - 2026-01-07 16:30:45  (11.5 KB)

# å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬
uv run casaos-gen --rollback meta.20260108_120510.json
```

---

### 2. params.yml é…ç½®ç¤ºä¾‹

```yaml
app:
  title: "æˆ‘çš„åšå®¢ç³»ç»Ÿ"
  user_input: true      # æ ‡è®°ä¸ºç”¨æˆ·è¾“å…¥ï¼ŒAI ä¼šæ¶¦è‰²
  multilang: true       # éœ€è¦å¤šè¯­è¨€åŒ–

  tagline: ""           # ç©ºç™½ï¼ŒAI è‡ªåŠ¨ç”Ÿæˆ

  description: "ä¸€ä¸ªç®€å•çš„ä¸ªäººåšå®¢"
  user_input: true
  multilang: true

services:
  web:
    ports:
      - container: "80"
        description: "ä¸»è¦ Web è®¿é—®ç«¯å£"
        user_input: true   # ç”¨æˆ·æä¾›ï¼ŒAI æ¶¦è‰²
        multilang: true    # å¤šè¯­è¨€åŒ–

      - container: "443"
        description: ""    # AI è‡ªåŠ¨ç”Ÿæˆ
        multilang: true

    envs:
      - container: "DEBUG"
        description: "Development debug toggle"
        user_input: false  # æŠ€æœ¯å­—æ®µ
        multilang: false   # ä¿æŒè‹±æ–‡

      - container: "DB_HOST"
        description: ""    # AI ç”Ÿæˆ
        multilang: true
```

---

### 3. å·¥ä½œæµç¨‹ç¤ºä¾‹

#### åœºæ™¯ 1: é¦–æ¬¡éƒ¨ç½²
```bash
# Step 1: å‡†å¤‡ compose å’Œ params
cat > params.yml << EOF
app:
  title: "RagFlow AI"
  user_input: true
  multilang: true
services:
  web:
    ports:
      - container: "80"
        description: "ä¸»ç•Œé¢ç«¯å£"
        user_input: true
        multilang: true
EOF

# Step 2: ç”Ÿæˆï¼ˆAI ä¼šæ¶¦è‰²ç”¨æˆ·è¾“å…¥ï¼‰
uv run casaos-gen compose.yml --params params.yml --incremental

# è¾“å‡ºï¼š
# â†’ é¦–æ¬¡ç”Ÿæˆï¼Œæ‰§è¡Œå®Œæ•´æµç¨‹
# â†’ è°ƒç”¨ AI æ¶¦è‰² 2 ä¸ªç”¨æˆ·è¾“å…¥å­—æ®µ
# â†’ è°ƒç”¨ AI ç”Ÿæˆ 5 ä¸ªç©ºç™½å­—æ®µ
# â†’ å¤šè¯­è¨€æ‰©å±•ï¼ˆ15 ç§è¯­è¨€ï¼‰
# âœ“ å·²ä¿å­˜åˆ° .casaos-gen/meta.current.json
```

#### åœºæ™¯ 2: å¢é‡æ›´æ–°ï¼ˆ1 å‘¨åï¼‰
```bash
# compose.yml å˜æ›´ï¼š
# - web æœåŠ¡æ–°å¢ç«¯å£ 8080
# - æ–°å¢ redis æœåŠ¡

# æ‰§è¡Œå¢é‡æ›´æ–°
uv run casaos-gen compose.yml --incremental

# è¾“å‡ºï¼š
# â†’ æ£€æµ‹åˆ°å·²æœ‰ç‰ˆæœ¬ï¼Œæ‰§è¡Œå¢é‡æ›´æ–°
#
# === å˜æ›´æ‘˜è¦ ===
# âœ“ æ–°å¢æœåŠ¡: redis
# + æ–°å¢å­—æ®µ: 2 ä¸ª
#   + services.web.ports.8080
#   + services.redis.ports.6379
#
# â†’ å¯¹ 2 ä¸ªæ–°å­—æ®µè°ƒç”¨ AI
# â†’ ä¿ç•™å·²æœ‰çš„ 12 ä¸ªå­—æ®µæè¿°ï¼ˆä¹‹å‰ç”Ÿæˆçš„å†…å®¹ï¼‰
# âœ“ å·²å¤‡ä»½æ—§ç‰ˆæœ¬åˆ° history/meta.20260108_143022.json
# âœ“ è¾“å‡ºåˆ° casaos.yml
```

---

## ğŸ“Š æ ¸å¿ƒä¼˜åŠ¿

### æˆæœ¬ä¼˜åŒ–
- **AI æˆæœ¬é™ä½ 80%+**ï¼šå¢é‡æ›´æ–°åªå¯¹æ–°å¢å­—æ®µè°ƒç”¨ AI
- **æ™ºèƒ½ç¼“å­˜**ï¼šæœªå˜åŒ–çš„ compose ç›´æ¥è¿”å›ç¼“å­˜

### ç”¨æˆ·ä½“éªŒ
- **ä¿ç•™ä¿®æ”¹**ï¼šæ‰‹åŠ¨è°ƒæ•´çš„ description ä¸ä¼šä¸¢å¤±
- **ç‰ˆæœ¬å®‰å…¨**ï¼šè‡ªåŠ¨å¤‡ä»½ï¼Œéšæ—¶å›æ»š
- **çµæ´»æ§åˆ¶**ï¼šå­—æ®µçº§åˆ«æ§åˆ¶ AI è¡Œä¸ºå’Œå¤šè¯­è¨€åŒ–

### å¼€å‘æ•ˆç‡
- **æ¨¡å—åŒ–è®¾è®¡**ï¼šæ¯ä¸ªé˜¶æ®µç‹¬ç«‹ï¼Œæ˜“äºæµ‹è¯•å’Œæ‰©å±•
- **CLI + Web UI**ï¼šé€‚åˆä¸åŒä½¿ç”¨åœºæ™¯
- **è¯¦ç»†æ—¥å¿—**ï¼šå˜æ›´å¯è§æ€§é«˜

---

## ğŸ—‚ï¸ é¡¹ç›®ç»“æ„

```
casaos_gen/
â”œâ”€â”€ models.py              # æ•°æ®æ¨¡å‹ï¼ˆæ‰©å±•äº† user_input å’Œ multilangï¼‰
â”œâ”€â”€ diff_engine.py         # å·®å¼‚å¯¹æ¯”å¼•æ“
â”œâ”€â”€ version_manager.py     # ç‰ˆæœ¬ç®¡ç†
â”œâ”€â”€ incremental.py         # å¢é‡æ›´æ–°ä¸»æµç¨‹
â”œâ”€â”€ llm_stage1.py          # LLM ç”Ÿæˆï¼ˆæ”¯æŒ only_fill_emptyï¼‰
â”œâ”€â”€ refine_mode.py         # AI æ¶¦è‰²æ¨¡å¼
â”œâ”€â”€ i18n.py                # å¤šè¯­è¨€ï¼ˆæ”¯æŒå­—æ®µçº§æ§åˆ¶ï¼‰
â”œâ”€â”€ cli.py                 # CLIï¼ˆæ‰©å±•äº†å¢é‡å‘½ä»¤ï¼‰
â”œâ”€â”€ webui.py               # Web UIï¼ˆæ–°å¢ç‰ˆæœ¬ç®¡ç† APIï¼‰
â””â”€â”€ ...

.casaos-gen/               # ç‰ˆæœ¬ç®¡ç†ç›®å½•ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰
â”œâ”€â”€ meta.current.json      # å½“å‰å…ƒæ•°æ®
â”œâ”€â”€ compose.hash           # compose æ–‡ä»¶å“ˆå¸Œ
â”œâ”€â”€ compose.old.yml        # å¯¹æ¯”åŸºå‡†
â”œâ”€â”€ history/               # å†å²ç‰ˆæœ¬
â”‚   â”œâ”€â”€ meta.20260108_143022.json
â”‚   â”œâ”€â”€ meta.20260107_093015.json
â”‚   â””â”€â”€ meta.20260106_171205.json
â””â”€â”€ config.json            # é…ç½®ï¼ˆä¿ç•™ç‰ˆæœ¬æ•°ç­‰ï¼‰
```

---

## âš™ï¸ é…ç½®

### .casaos-gen/config.json
```json
{
  "max_history_versions": 3,        // æœ€å¤šä¿ç•™å†å²ç‰ˆæœ¬æ•°
  "enable_version_control": true,   // å¯ç”¨ç‰ˆæœ¬æ§åˆ¶
  "auto_backup_before_update": true // æ›´æ–°å‰è‡ªåŠ¨å¤‡ä»½
}
```

---

## ğŸ› ï¸ å¼€å‘åŸåˆ™ï¼ˆå·²éµå¾ªï¼‰

### KISSï¼ˆç®€å•è‡³ä¸Šï¼‰
- âœ… å·®å¼‚å¯¹æ¯”ç®—æ³•ç›´è§‚æ¸…æ™°
- âœ… ç‰ˆæœ¬ç®¡ç†åŸºäºæ–‡ä»¶ç³»ç»Ÿï¼Œæ— éœ€æ•°æ®åº“

### YAGNIï¼ˆç²¾ç›Šæ±‚ç²¾ï¼‰
- âœ… åªå®ç°æ˜ç¡®éœ€æ±‚çš„åŠŸèƒ½
- âœ… ç§»é™¤äº†å¤æ‚çš„é¢„æµ‹æ€§ç‰¹æ€§

### DRYï¼ˆæœç»é‡å¤ï¼‰
- âœ… å¤šè¯­è¨€é€»è¾‘ç»Ÿä¸€åœ¨ `i18n.py`
- âœ… LLM è°ƒç”¨å°è£…åœ¨ `llm_stage1.py` å’Œ `refine_mode.py`

### SOLID
- âœ… **SRP**ï¼šæ¯ä¸ªæ¨¡å—å•ä¸€èŒè´£æ˜ç¡®
- âœ… **OCP**ï¼šæ‰©å±•ç‚¹å¼€æ”¾ï¼ˆLLM é…ç½®ã€ç¿»è¯‘è¡¨ï¼‰
- âœ… **DIP**ï¼šä¾èµ–æŠ½è±¡ï¼ˆVersionManager æ¥å£æ¸…æ™°ï¼‰

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **é¦–æ¬¡ä½¿ç”¨**ï¼šæ— ç‰ˆæœ¬å†å²ï¼Œæ‰§è¡Œå®Œæ•´ç”Ÿæˆæµç¨‹
2. **LLM é…ç½®**ï¼šå¢é‡æ¨¡å¼éœ€è¦é…ç½® API Key
3. **Backup ç®¡ç†**ï¼šè¶…è¿‡ 3 ä¸ªç‰ˆæœ¬ä¼šè‡ªåŠ¨æ¸…ç†æœ€æ—§çš„
4. **æ–‡ä»¶å“ˆå¸Œ**ï¼šåŸºäºå†…å®¹æ£€æµ‹å˜åŒ–ï¼Œé‡å‘½åä¸è§¦å‘æ›´æ–°

---

## ğŸ¯ åç»­å¯æ‰©å±•æ–¹å‘

- [ ] Web UI å‰ç«¯å®Œæ•´å®ç°ï¼ˆç‰ˆæœ¬å†å²å¯è§†åŒ–ï¼‰
- [ ] æ”¯æŒæ›´å¤š AI æ¨¡å‹ï¼ˆClaude, Gemini ç­‰ï¼‰
- [ ] å·®å¼‚å¯è§†åŒ–ï¼ˆé«˜äº®å˜æ›´ï¼‰
- [ ] æ‰¹é‡å¤„ç†å¤šä¸ª compose æ–‡ä»¶
- [ ] Git é›†æˆï¼ˆè‡ªåŠ¨æäº¤å˜æ›´ï¼‰

---

## è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·æäº¤ Issue æˆ– Pull Requestã€‚
